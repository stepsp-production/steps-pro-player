<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Steps VIP Production Co Player</title>

  <!-- HLS.js -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <!-- أيقونة بسيطة -->
  <link rel="icon"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%230b0b0f'/%3E%3Cpolygon points='26,20 26,44 46,32' fill='%23e53935'/%3E%3C/svg%3E" />

  <style>
    :root{--btn-bg:#e53935;--btn-bg-h:#d32f2f;--btn-bg-a:#b71c1c;--btn-txt:#fff;--panel-bg:#0b0b0fcc;--panel-bd:#ffffff26}
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:#000;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #playerContainer{position:relative;width:100vw;height:100vh}
    .videoFrame{position:absolute;top:0;right:0;width:100%;height:100%;background:#000;overflow:hidden}
    #mainPreview{position:absolute;top:16px;right:20px;width:22%;height:24%;z-index:6;border:1px solid #fff2;border-radius:18px;cursor:pointer;transition:transform .18s,box-shadow .18s,width .18s,height .18s,top .18s,right .18s,left .18s}
    #mainPreview:hover{box-shadow:0 10px 30px #0008}
    #mainPreview video{display:block;width:100%;height:100%;object-fit:contain}

    /* تقسيم */
    .split #mainPreview{top:0;right:0;width:50%;height:100%;border:0;border-radius:0;cursor:default}
    .split #activeCam{top:0;left:0;right:auto;width:50%;height:100%}
    .split.fill #mainPreview video,
    .split.fill #activeCam video{object-fit:cover}

    /* تكبير المعاينة الرئيسية */
    .main-full #mainPreview{top:0;right:0;width:100%;height:100%;z-index:7;border:0;border-radius:0;cursor:zoom-out}
    .main-full #activeCam{display:none}
    .main-full.cover #mainPreview video{object-fit:cover}

    .hint{position:absolute;top:20px;right:20px;z-index:8;background:#000a;color:#fff;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #fff2}
    .split .hint,.main-full .hint{display:none}

    /* أشرطة/أزرار */
    #utilityControls,#camControls,#globalControls{position:absolute;z-index:10;display:flex;gap:8px;flex-wrap:wrap}
    #utilityControls{top:10px;right:10px}
    #globalControls{bottom:70px;left:50%;transform:translateX(-50%);background:var(--panel-bg);padding:10px;border-radius:14px;border:1px solid var(--panel-bd);align-items:center;min-width:340px}
    #globalControls.hidden{display:none}

    button{-webkit-tap-highlight-color:transparent;appearance:none;border:0;outline:0;cursor:pointer;background:var(--btn-bg);color:var(--btn-txt);padding:11px 12px;font-size:12px;font-weight:800;border-radius:12px;letter-spacing:.2px;display:inline-flex;align-items:center;gap:8px;box-shadow:0 8px 18px #000a,0 0 0 0 rgba(211,47,47,.28);transition:transform .12s,box-shadow .12s,background .12s}
    button:hover{background:var(--btn-bg-h);box-shadow:0 12px 26px #000c,0 0 0 6px rgba(211,47,47,.28)} button:active{background:var(--btn-bg-a);transform:translateY(1px)}

    #scrub{-webkit-appearance:none;appearance:none;width:320px;height:6px;border-radius:999px;background:#ffffff30;outline:none;margin:0 8px}
    #scrub::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:#fff;border:2px solid #0006;cursor:pointer}
    #timeLabel{color:#fff;font-size:12px;min-width:108px;text-align:center}

    #gatePlay{position:absolute;inset:0;z-index:9;display:flex;align-items:center;justify-content:center;background:linear-gradient(140deg,rgba(0,0,0,.55),rgba(0,0,0,.2))}
    #gatePlay.hidden{display:none}
    .gate-card{background:var(--panel-bg);border:1px solid var(--panel-bd);border-radius:18px;padding:18px 20px;display:flex;gap:12px;align-items:center;box-shadow:0 10px 40px rgba(0,0,0,.45)}
    .gate-card .icon{width:32px;height:32px;border-radius:50%;display:grid;place-items:center;border:1px solid var(--panel-bd);color:#fff;background:#111a;font-size:18px}
    #startBtn{min-width:160px}

    #camControls{bottom:14px;left:50%;transform:translateX(-50%);background:var(--panel-bg);padding:10px;border-radius:14px;border:1px solid var(--panel-bد)}

    /* --- لوحة المصادر الجانبية الجديدة --- */
    #streamPanel{
      position:absolute; top:0; left:0; height:100%; width:220px; z-index:11;
      background:linear-gradient(180deg,#0b0b0fe6,#0b0b0fb3);
      border-right:1px solid var(--panel-bd);
      padding:12px 10px; color:#fff; backdrop-filter: blur(6px);
      box-shadow: 12px 0 28px rgba(0,0,0,.35);
    }
    #streamPanel .panel-title{font-weight:900;letter-spacing:.8px;margin:6px 6px 12px;font-size:13px;opacity:.9}
    #streamList{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:6px;max-height:calc(100% - 48px);overflow:auto}
    .stream-item{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      padding:10px 12px; border-radius:12px; cursor:pointer;
      border:1px solid #ffffff18; background:#12151fb0; transition:background .12s, transform .06s, border-color .12s;
    }
    .stream-item:hover{background:#1b2030cc;border-color:#ffffff30}
    .stream-item.active{background:#26324dcc;border-color:#ffffff55; box-shadow: inset 0 0 0 1px #0006}
    .stream-name{font-weight:800; font-size:12px; letter-spacing:.4px; text-transform:uppercase}
    .stream-actions{display:flex; gap:6px}
    .icon-btn{
      width:28px; height:28px; display:grid; place-items:center; border-radius:8px;
      background:#ffffff12; border:1px solid #ffffff24; color:#fff; font-size:13px; line-height:1;
    }
    .icon-btn:hover{background:#ffffff22}
    .copy-toast{
      position:absolute; bottom:14px; left:14px; background:#0b0b0fcc; color:#fff; font-size:12px;
      padding:8px 10px; border-radius:10px; border:1px solid #ffffff26; opacity:0; transform:translateY(6px);
      transition:opacity .18s, transform .18s; pointer-events:none; z-index:12;
    }
    .copy-toast.show{opacity:1; transform:translateY(0)}
    /* يُصغّر في الوضع الرأسي */
    @media (orientation: portrait){
      #mainPreview{top:12px;right:14px;width:58vw;height:36vh;border-radius:18px}
      #globalControls{position:fixed;bottom:calc(env(safe-area-inset-bottom,0px) + 8px);left:50%;transform:translateX(-50%);width:min(94vw,560px);padding:8px 10px;z-index:9999}
      #scrub{width:clamp(140px,56vw,380px)}
      #camControls{top:60px;left:6px;right:auto;bottom:auto;flex-direction:column;gap:6px;padding:8px 6px;max-height:58vh;overflow:auto;background:linear-gradient(180deg,#0b0b0fb3,#0b0b0f99);border:1px solid var(--panel-bd);border-radius:14px;width:46px;transition:width .18s,box-shadow .18s;box-shadow:0 8px 24px rgba(0,0,0,.35);z-index:12}
      #camControls:hover,#camControls.expanded{width:150px}
      #camControls button{justify-content:flex-start;padding:8px 10px;width:100%;font-size:10px;background:#1a1f2a;color:#fff;border:1px solid #ffffff1f;box-shadow:inset 0 0 0 1px #0003}
      #camControls:not(.expanded):not(:hover) button span{display:none}
      /* تصغير لوحة المصادر */
      #streamPanel{width:180px}
    }
  </style>
</head>
<body>
  <div id="playerContainer" aria-label="مشغّل متعدد الكاميرات">
    <!-- لوحة المصادر الجديدة -->
    <aside id="streamPanel" aria-label="مصادر البث">
      <div class="panel-title">SOURCES</div>
      <ul id="streamList"></ul>
      <div id="copyToast" class="copy-toast">تم النسخ</div>
    </aside>

    <div id="activeCam" class="videoFrame" aria-label="الكاميرا النشطة"></div>
    <div id="mainPreview" class="videoFrame" title="انقر للتكبير/التصغير" aria-label="المعاينة الرئيسية المصغّرة"></div>
    <div class="hint">انقر على المعاينة للتكبير • أو اضغط F</div>

    <!-- بوابة البدء -->
    <div id="gatePlay" role="dialog" aria-modal="true" aria-label="بدء التشغيل">
      <div class="gate-card">
        <div class="icon">▶</div>
        <div>
          <div style="color:#fff;font-weight:800;margin-bottom:6px">ابدأ التشغيل والمزامنة</div>
          <div style="font-size:12px;color:#eaeaf0b3">سيظهر شريط التقديم/التأخير بعد الضغط على تشغيل</div>
        </div>
        <button id="startBtn" aria-label="ابدأ التشغيل الآن">تشغيل/بدء المزامنة</button>
      </div>
    </div>

    <!-- أدوات -->
    <div id="utilityControls" role="toolbar" aria-label="أدوات">
      <button id="btnSplit" aria-label="تبديل وضع التقسيم" title="تقسيم">تقسيم</button>
      <button id="btnFill"  aria-label="تبديل الملء" title="ملء">ملء</button>
      <button id="btnSound" aria-label="تشغيل/إيقاف الصوت" title="صوت">🔊/🔇</button>
    </div>

    <!-- الشريط الموحّد -->
    <div id="globalControls" class="hidden" role="group" aria-label="تحكم موحّد">
      <button id="gBack" title="⏪ -5s">⏪ 5s</button>
      <button id="gPlay" title="⏯">⏯</button>
      <button id="gFwd"  title="+5s ⏩">5s ⏩</button>
      <input id="scrub" type="range" min="0" max="0" value="0" step="0.01" aria-label="شريط التقدم">
      <div id="timeLabel">00:00 / 00:00</div>
    </div>

    <!-- الكاميرات (موجودة كما هي للحفاظ على الميزات) -->
    <div id="camControls" role="toolbar" aria-label="اختيار الكاميرات">
      <button data-cam="cam1"><span>Cam1</span></button>
      <button data-cam="cam2"><span>Cam2</span></button>
      <button data-cam="cam3"><span>Cam3</span></button>
      <button data-cam="cam4"><span>Cam4</span></button>
      <button data-cam="cam5"><span>Cam5</span></button>
      <button data-cam="cam6"><span>Drone</span></button>
      <button data-cam="cam7"><span>Sineflex</span></button>
    </div>
  </div>

<script>
  /* ===== المصادر عبر البروكسي /hls/ ===== */
  window.sources = {
    main: "/hls/live/playlist.m3u8",
    cam1: "/hls/lastone/playlist.m3u8",
    cam2: "/hls/live2/playlist.m3u8",
    cam3: "/hls/live3/playlist.m3u8",
    cam4: "/hls/live4/playlist.m3u8",
    cam5: "/hls/live5/playlist.m3u8",
    cam6: "/hls/live6/playlist.m3u8",   // CineFlex / Helicopter
    cam7: "/hls/live7/playlist.m3u8"    // DRONE
  };

  /* خريطة أسماء العرض (كما في الصورة) -> يمكن تعديلها بحرّية */
  window.channelMap = [
    { id:'main', label:'MAIN'       , src: window.sources.main },
    { id:'cam2', label:'TRACKING'   , src: window.sources.cam2 },
    { id:'cam6', label:'HELICOPTER' , src: window.sources.cam6 },
    { id:'cam3', label:'JOCKEY'     , src: window.sources.cam3 },
    { id:'cam7', label:'DRONE'      , src: window.sources.cam7 },
    { id:'cam4', label:'STARTS'     , src: window.sources.cam4 },
    { id:'cam5', label:'WIN POST'   , src: window.sources.cam5 },
    // يمكن إضافة المزيد بسهولة
  ];
</script>

<script>
  /* ====== إعدادات عامة ====== */
  const hasUrl = (u)=> typeof u==='string' && /^\/hls\/.+\.m3u8(\?.*)?$/i.test(u);
  const SAFETY_EDGE = 0.25; // نبتعد قليلًا عن نهاية نافذة البث لتفادي إعادة التحميل

  function isAvc(l){ return /avc1/i.test(l?.codecs || l?.codecsVideo || ""); }
  function isHevc(l){ return /(hvc1|hev1)/i.test(l?.codecs || l?.codecsVideo || ""); }
  function pickBestAvc(levels, capHeight=480){
    if(!levels?.length) return -1;
    const avc = levels.map((l,i)=>({i,h:l.height||0,avc:isAvc(l)})).filter(x=>x.avc);
    if(!avc.length) return 0;
    let candidates = avc.filter(x=>x.h && x.h<=capHeight);
    if(!candidates.length) candidates = avc;
    candidates.sort((a,b)=>a.h-b.h);
    return candidates[candidates.length-1].i;
  }
  function highestAvcIndex(levels){
    let max=-1; (levels||[]).forEach((l,i)=>{ if(isAvc(l)) max=i; });
    return max>=0 ? max : (levels?.length? levels.length-1 : -1);
  }

  // إعدادات Hls.js كما كانت
  const HLS_CFG = {
    lowLatencyMode:false,
    liveSyncDurationCount:3,
    capLevelToPlayerSize:true,
    enableWorker:true,
    maxBufferHole:1.0,
    maxSeekHole:2.0,
    nudgeOffset:0.2,
    nudgeMaxRetry:6,
    abrMaxWithRealBitrate:true,
    fragLoadingMaxRetry:6, manifestLoadingMaxRetry:6, levelLoadingMaxRetry:5,
    fragLoadingRetryDelay:350, manifestLoadingRetryDelay:500, levelLoadingRetryDelay:500,
    fragLoadingTimeOut:10000, manifestLoadingTimeOut:8000, levelLoadingTimeOut:8000,
    xhrSetup:(xhr)=>{ try{ xhr.withCredentials=false; }catch(e){} }
  };

  /* ====== أدوات مساعدة ====== */
  function getSeekableRange(v){
    try{
      const r=v.seekable; if(!r||!r.length) return null;
      return {start:r.start(r.length-1), end:r.end(r.length-1)};
    }catch(e){ return null; }
  }
  function clampToSeekable(v,t){
    const m=getSeekableRange(v); if(!m) return t;
    const a=m.start+0.02, b=m.end-0.02;
    if(b<=a) return m.start;
    return Math.min(Math.max(t,a), b);
  }
  async function waitForSeekable(v, timeout=8000){
    const t0=performance.now();
    return new Promise((res)=>{ (function loop(){
      try{ const r=v.seekable; if(r&&r.length) return res(true); }catch(e){}
      if(performance.now()-t0>timeout) return res(false);
      setTimeout(loop,120);
    })(); });
  }
  async function healGapIfNeeded(v){
    try{
      const r=v.buffered; if(!r||!r.length) return false;
      const t=v.currentTime||0;
      for(let i=0;i<r.length;i++){ const s=r.start(i), e=r.end(i);
        if(t>=s && t<=e) return false;
        if(t< s){ v.currentTime = s+0.04; await v.play().catch(()=>{}); return true; }
      }
    }catch(e){}
    return false;
  }

  /* ====== إنشاء فيديو مع Hls.js (AVC فقط) ====== */
  function attachHlsWithAvc(video, url){
    const hls = new Hls({...HLS_CFG});
    video.__hls = hls;
    hls.attachMedia(video);
    hls.on(Hls.Events.MEDIA_ATTACHED,()=>{ hls.loadSource(url); });

    hls.on(Hls.Events.MANIFEST_PARSED,(_,data)=>{
      try{
        const levels=data?.levels||[];
        const startIdx = pickBestAvc(levels, 480);
        const maxAvcIdx = highestAvcIndex(levels);
        if(startIdx >= 0){ hls.startLevel=startIdx; hls.currentLevel=startIdx; hls.nextLevel=startIdx; }
        if(maxAvcIdx >= 0){ hls.autoLevelCapping = maxAvcIdx; }
      }catch(e){}
    });

    hls.on(Hls.Events.LEVEL_SWITCHING,(_,data)=>{
      try{
        const l = hls.levels?.[data.level];
        if(l && isHevc(l)){
          const lv=hls.levels||[];
          const avc = lv.map((x,i)=>({i,h:x.height||0,avc:isAvc(x)})).filter(x=>x.avc);
          if(avc.length){ let best = avc.reduce((a,b)=> b.h<=480 && b.h>a.h ? b : a, avc[0]); hls.nextLevel = best.i; }
        }
      }catch(e){}
    });

    hls.on(Hls.Events.ERROR,(_,err)=>{
      if(err?.fatal){
        try{ hls.destroy(); }catch(e){}
        try{ attachHlsWithAvc(video, url); }catch(e){}
      }
    });

    return hls;
  }

  function wireStallHandlers(v){
    const nudge = ()=> {
      if (!v) return;
      healGapIfNeeded(v);
      try{ v.play().catch(()=>{}); }catch(_){}
    };
    v.addEventListener('stalled', nudge);
    v.addEventListener('waiting', nudge);
    v.addEventListener('suspend', ()=>{});
  }

  function createVideo(container, url){
    const wrap=document.createElement('div'); wrap.style.cssText='position:absolute;inset:0';
    container.appendChild(wrap);
    const v=document.createElement('video');
    v.playsInline=true; v.muted=true; v.controls=false; v.preload='auto'; v.crossOrigin='anonymous';
    v.style.cssText='width:100%;height:100%;object-fit:contain';
    wrap.appendChild(v);
    wireStallHandlers(v);

    if(hasUrl(url) && window.Hls && Hls.isSupported()){
      attachHlsWithAvc(v, url);
    }else if(hasUrl(url) && v.canPlayType('application/vnd.apple.mpegURL')){
      v.src=url;
    }else{
      v.src=url;
    }

    v.addEventListener('canplay', ()=>{
      [...container.children].slice(0,-1).forEach(ch=>{
        try{ const vv=ch.querySelector?.('video'); vv?.pause?.(); vv?.__hls?.destroy?.(); ch.remove(); }catch(e){}
      });
    }, {once:true});

    return v;
  }

  /* ====== DOM & حالة ====== */
  const root=document.getElementById('playerContainer');
  const mainContainer=document.getElementById('mainPreview');
  const camContainer =document.getElementById('activeCam');
  const gatePlay     =document.getElementById('gatePlay');
  const startBtn     =document.getElementById('startBtn');
  const btnSplit     =document.getElementById('btnSplit');
  const btnFill      =document.getElementById('btnFill');
  const btnSound     =document.getElementById('btnSound');
  const globalControls=document.getElementById('globalControls');
  const gPlay=document.getElementById('gPlay');
  const gBack=document.getElementById('gBack');
  const gFwd=document.getElementById('gFwd');
  const scrub=document.getElementById('scrub');
  const timeLabel=document.getElementById('timeLabel');

  /* عناصر اللوحة الجديدة */
  const streamPanel=document.getElementById('streamPanel');
  const streamList=document.getElementById('streamList');
  const copyToast=document.getElementById('copyToast');

  let started=false;
  let splitMode=0;          // 0: عادي، 1: تقسيم (contain), 2: تقسيم (cover)
  let isMainFull=false;     // تكبير المعاينة الرئيسية
  let coverMain=false;      // عند التكبير: cover لإزالة الحواف
  let splitFillPhase=0;     // لتتبع ضغطات "ملء" داخل وضع التقسيم (0→1 contain، 1→2 cover)

  let mainPlayer, activePlayer, currentCam='cam2';
  let ticker=null, isScrubbing=false;

  function fmt(t){ t=Math.max(0,Math.floor(t||0)); const m=String(Math.floor(t/60)).padStart(2,'0'); const s=String(t%60).padStart(2,'0'); return `${m}:${s}`; }

  function initPlayers(){
    if(!mainPlayer) mainPlayer=createVideo(mainContainer, sources.main);
    activePlayer=createVideo(camContainer, sources[currentCam]);
  }

  /* === بناء قائمة المصادر الجانبية === */
  function buildStreamList(){
    streamList.innerHTML='';
    const visibleChannels = (window.channelMap||[]).filter(ch=>hasUrl(ch.src));
    visibleChannels.forEach((ch,idx)=>{
      const li=document.createElement('li'); li.className='stream-item'; li.dataset.cam=ch.id;
      const name=document.createElement('div'); name.className='stream-name'; name.textContent = ch.label;
      const actions=document.createElement('div'); actions.className='stream-actions';
      const open=document.createElement('a'); open.className='icon-btn'; open.href=ch.src; open.target='_blank'; open.title='فتح الرابط المباشر'; open.textContent='↗';
      const copy=document.createElement('button'); copy.className='icon-btn'; copy.type='button'; copy.title='نسخ الرابط'; copy.textContent='⎘';
      copy.addEventListener('click',(ev)=>{
        ev.stopPropagation();
        navigator.clipboard.writeText(location.origin + ch.src).then(()=>{
          copyToast.textContent='تم نسخ الرابط: ' + ch.label;
          copyToast.classList.add('show'); setTimeout(()=>copyToast.classList.remove('show'),900);
        }).catch(()=>{
          copyToast.textContent='تعذّر النسخ'; copyToast.classList.add('show'); setTimeout(()=>copyToast.classList.remove('show'),900);
        });
      });
      actions.appendChild(copy); actions.appendChild(open);
      li.appendChild(name); li.appendChild(actions);
      li.addEventListener('click',()=> setActiveCam(ch.id));
      streamList.appendChild(li);
    });

    // مفاتيح سريعة 1..9 للتبديل حسب الترتيب
    document.addEventListener('keydown',(e)=>{
      if(e.target && ['INPUT','TEXTAREA'].includes(e.target.tagName)) return;
      const n = Number(e.key);
      if(n>=1 && n<=visibleChannels.length){
        setActiveCam(visibleChannels[n-1].id);
      }
    });
  }

  function markActiveList(){
    document.querySelectorAll('.stream-item').forEach(el=>{
      el.classList.toggle('active', el.dataset.cam===currentCam);
    });
  }

  function setActiveCam(id){
    if(!sources[id]) return;
    currentCam=id;
    activePlayer = createVideo(camContainer, sources[currentCam]);
    markActiveList();
  }

  function initOnce(){
    initPlayers();
    // إخفاء أزرار الكاميرات غير المتوفرة (كما في كودك)
    document.querySelectorAll('#camControls [data-cam]').forEach(btn=>{
      const id=btn.getAttribute('data-cam');
      if(id!=='cam1' && !hasUrl(sources[id])) btn.style.display='none';
      btn.addEventListener('click', ()=> setActiveCam(id)); // ربط القديم بالجديد
    });
    buildStreamList();
    markActiveList();
    applyLayout();
  }
  initOnce();

  /* ====== تطبيق الـ layout ====== */
  function applyLayout(){
    root.classList.toggle('split', splitMode!==0);
    root.classList.toggle('fill',  splitMode===2);
    root.classList.toggle('main-full', isMainFull);
    root.classList.toggle('cover',     isMainFull && coverMain);
  }

  /* ====== تشغيل أولي ====== */
  async function startPlayback(){
    if(started) return;
    started=true;
    gatePlay.classList.add('hidden');
    globalControls.classList.remove('hidden');

    try{ await mainPlayer.play(); }catch(e){}
    try{ await activePlayer.play(); }catch(e){}

    setTimeout(async ()=>{
      await waitForSeekable(mainPlayer);
      const m=getSeekableRange(mainPlayer);
      if(m){ mainPlayer.currentTime = clampToSeekable(mainPlayer, m.end - SAFETY_EDGE); }
    }, 300);

    startTimeTicker();
  }

  function startTimeTicker(){
    if(ticker) return;
    ticker=setInterval(()=>{
      if(isScrubbing) return;

      let d=0, ct=mainPlayer.currentTime||0;
      const r=mainPlayer.seekable; if(r&&r.length) d=r.end(r.length-1);
      if(d&&isFinite(d)) scrub.max=d;
      scrub.value=ct||0; timeLabel.textContent=`${fmt(ct)} / ${fmt(d||0)}`;

      healGapIfNeeded(mainPlayer);
      healGapIfNeeded(activePlayer);

      const target = ct;
      const delta = (activePlayer.currentTime||0) - target;
      if (Math.abs(delta) > 1.2){
        mainPlayer.currentTime = clampToSeekable(mainPlayer, target);
        activePlayer.currentTime = clampToSeekable(activePlayer, target);
        return;
      }
      if (Math.abs(delta) < 0.08){ activePlayer.playbackRate=1; }
      else if (Math.abs(delta) < 0.30){ activePlayer.playbackRate = (delta>0?0.985:1.015); }
      else if (Math.abs(delta) < 0.70){ activePlayer.playbackRate = (delta>0?0.95:1.05); }
      else { activePlayer.playbackRate = 1; }
    }, 300);
  }

  /* ====== تحكمات ====== */
  startBtn.addEventListener('click', startPlayback);

  // زر التقسيم: 3 حالات
  btnSplit.addEventListener('click', ()=>{
    splitMode = (splitMode + 1) % 3;
    splitFillPhase = 0;
    applyLayout();
  });

  // زر الملء — كما في كودك
  btnFill.addEventListener('click', ()=>{
    if (splitMode === 0){
      if (!isMainFull){ isMainFull = true; coverMain = true; }
      else { isMainFull = false; coverMain = false; }
    } else {
      if (splitFillPhase === 0){ splitMode = 1; splitFillPhase = 1; }
      else if (splitFillPhase === 1){ splitMode = 2; splitFillPhase = 2; }
      else { splitMode = (splitMode === 2) ? 1 : 2; splitFillPhase = (splitMode === 2) ? 2 : 1; }
    }
    applyLayout();
  });

  btnSound.addEventListener('click', ()=>{
    if(!started) return;
    mainPlayer.muted = !mainPlayer.muted;
    if(!mainPlayer.muted) mainPlayer.play().catch(()=>{});
  });

  const gSeek = (ofs)=>{
    if(!started) return;
    const t=(mainPlayer.currentTime||0)+ofs;
    mainPlayer.currentTime = clampToSeekable(mainPlayer,t);
    activePlayer.currentTime = clampToSeekable(activePlayer,t);
  };
  gBack.addEventListener('click', ()=> gSeek(-5));
  gFwd .addEventListener('click', ()=> gSeek( 5));
  gPlay.addEventListener('click', async()=>{
    if(!started) return;
    if(mainPlayer.paused){ try{ await mainPlayer.play(); }catch(e){} }
    else { mainPlayer.pause(); }
  });

  scrub.addEventListener('input', ()=>{ if(started) isScrubbing=true; });
  scrub.addEventListener('change', ()=>{
    if(!started) return;
    const nt=parseFloat(scrub.value)||0;
    mainPlayer.currentTime = clampToSeekable(mainPlayer, nt);
    activePlayer.currentTime = clampToSeekable(activePlayer, nt);
    isScrubbing=false;
  });

  // تكبير/تصغير بالنقر على المعاينة
  mainContainer.addEventListener('click', ()=>{
    if(splitMode!==0) return; // فقط في الوضع العادي
    isMainFull=!isMainFull;
    if (!isMainFull) coverMain=false;
    applyLayout();
  });

  // اختصارات
  document.addEventListener('keydown',(e)=>{
    if(e.key===' '||e.key==='Enter'){ e.preventDefault(); startPlayback(); }
    if(e.key==='S'||e.key==='s'){ btnSplit.click(); }
    if(e.key==='F'||e.key==='f'){ mainContainer.click(); }
    if(e.key==='M'||e.key==='m'){ btnSound.click(); }
    if(e.key==='ArrowLeft'){ gBack.click(); }
    if(e.key==='ArrowRight'){ gFwd.click(); }
  });
</script>

<script>
/* Debug كما كان */
(function addHlsDebug(){
  function wireDebug(video){
    const h = video && video.__hls;
    if(!h) return;
    h.on(Hls.Events.MANIFEST_PARSED, (_, data)=>{
      console.log('[HLS] MANIFEST_PARSED levels=', (data && data.levels||[]).map(l=>({h:l.height, codecs:l.codecs})));
    });
    h.on(Hls.Events.LEVEL_LOADED, (_, data)=>{
      console.log('[HLS] LEVEL_LOADED targetduration=', data?.details?.targetduration, 'frags=', data?.details?.fragments?.length);
    });
    h.on(Hls.Events.ERROR, (_, err)=>{
      console.error('[HLS] ERROR', err?.type, err?.details, err);
    });
  }
  const mo = new MutationObserver(()=>{
    document.querySelectorAll('video').forEach(v=>{
      if(!v.__debugWired && v.__hls){
        v.__debugWired = true;
        wireDebug(v);
      }
    });
  });
  mo.observe(document.body, {childList:true, subtree:true});
})();
</script>
</body>
</html>
