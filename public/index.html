<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Steps Production Co Player</title>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>
<script src="https://player.vimeo.com/api/player.js"></script>

<link rel="icon"
  href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%230b0b0f'/%3E%3Cpolygon points='26,20 26,44 46,32' fill='%23e53935'/%3E%3C/svg%3E" />
<link rel="preconnect" href="https://stream.mux.com" crossorigin>
<link rel="preload" as="fetch" href="https://stream.mux.com/jIy7RfNkNJqkZ1008eyc01WH9i4Nh37Q001xqZEdA50000LI.m3u8" crossorigin>

<style>
:root{--btn-bg:#e53935;--btn-bg-h:#d32f2f;--btn-bg-a:#b71c1c;--btn-txt:#fff;--btn-ring:rgba(211,47,47,.28);--panel-bg:#0b0b0fbb;--panel-bd:#ffffff26}
*{box-sizing:border-box} html,body{height:100%} body{margin:0;background:#000;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
#playerContainer{position:relative;width:100vw;height:100vh}
.videoFrame{position:absolute;top:0;right:0;width:100%;height:100%;background:#000;overflow:hidden}
#freezeLayer{position:absolute;inset:0;z-index:5;pointer-events:none;opacity:0;transition:opacity .18s}
#mainPreview{position:absolute;top:16px;right:20px;width:22%;height:24%;z-index:6;border:1px solid #fff2;border-radius:18px;cursor:pointer;transition:all .18s}
#mainPreview:hover{box-shadow:0 10px 30px #0008}
#mainPreview video{width:100%;height:100%;object-fit:contain}
.split #mainPreview{top:0;right:0;width:50%;height:100%;border:0;border-radius:0;cursor:default}
.split #activeCam{top:0;left:0;right:auto;width:50%;height:100%}
.split.fill #mainPreview video,.split.fill #activeCam video{object-fit:cover}
.main-full #mainPreview{top:0;right:0;width:100%;height:100%;z-index:7;border:0;border-radius:0;cursor:zoom-out}
.main-full #activeCam{display:none}
.hint{position:absolute;top:20px;right:20px;z-index:8;background:#000a;color:#fff;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #fff2}
.split .hint,.main-full .hint{display:none}

#utilityControls,#camControls,#globalControls{position:absolute;z-index:10;display:flex;gap:8px;flex-wrap:wrap;transition:top .18s,left .18s,right .18s}
#utilityControls{background:transparent;padding:0;border:0;border-radius:12px}
#utilityControls.vertical{flex-direction:column} #utilityControls.horizontal{flex-direction:row}
#utilityControls .group{display:flex;gap:6px;align-items:center}
.divider{width:1px;height:22px;background:var(--panel-bd);border-radius:2px;margin:0 4px}
#camControls{bottom:14px;left:50%;transform:translateX(-50%);background:var(--panel-bg);padding:10px;border-radius:14px;border:1px solid var(--panel-bd);backdrop-filter:blur(8px)}

#globalControls{bottom:70px;left:50%;transform:translateX(-50%);background:var(--panel-bg);padding:10px;border-radius:14px;border:1px solid var(--panel-bd);backdrop-filter:blur(8px);align-items:center;min-width:340px}
#globalControls.hidden{display:none}
#scrub{-webkit-appearance:none;appearance:none;width:320px;height:6px;border-radius:999px;background:#ffffff30;outline:none;margin:0 8px}
#scrub::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:#fff;border:2px solid #0006;cursor:pointer}
#timeLabel{color:#fff;font-size:12px;min-width:108px;text-align:center}
#delayGroup{display:flex;align-items:center;gap:6px;margin-inline-start:10px}
#delayRange{-webkit-appearance:none;appearance:none;width:140px;height:6px;border-radius:999px;background:#ffffff30;outline:none}

button{-webkit-tap-highlight-color:transparent;appearance:none;border:0;outline:0;cursor:pointer;background:var(--btn-bg);color:var(--btn-txt);padding:11px 12px;font-size:12px;font-weight:800;border-radius:12px;letter-spacing:.2px;display:inline-flex;align-items:center;gap:8px;box-shadow:0 8px 18px #000a,0 0 0 0 var(--btn-ring);transition:all .12s;opacity:.35}
body.ui-awake button{opacity:1} button:hover{background:var(--btn-bg-h);box-shadow:0 12px 26px #000c,0 0 0 6px var(--btn-ring)} button:active{background:var(--btn-bg-a);transform:translateY(1px)}
#btnSound{min-width:auto;padding:6px 8px}
#btnSound[data-muted="true"] .on{display:none} #btnSound[data-muted="false"] .off{display:none}

#gatePlay{position:absolute;inset:0;z-index:9;display:flex;align-items:center;justify-content:center;background:linear-gradient(140deg,rgba(0,0,0,.55),rgba(0,0,0,.2));backdrop-filter:blur(2px)}
#gatePlay.hidden{display:none}
.gate-card{background:var(--panel-bg);border:1px solid var(--panel-bd);border-radius:18px;padding:18px 20px;display:flex;gap:12px;align-items:center;box-shadow:0 10px 40px rgba(0,0,0,.45)}
.gate-card .icon{width:32px;height:32px;border-radius:50%;display:grid;place-items:center;border:1px solid var(--panel-bd);color:#fff;background:#111a;font-size:18px}
#startBtn{min-width:160px}

@media(orientation:portrait){
  #mainPreview{top:12px;right:14px;width:58vw;height:36vh;border-radius:18px}
  #globalControls{position:fixed;bottom:calc(env(safe-area-inset-bottom,0px) + 8px);left:50%;transform:translateX(-50%);width:min(94vw,560px);padding:8px 10px;z-index:9999}
  #scrub{width:clamp(140px,56vw,380px)}
  #camControls{top:60px;left:6px;right:auto;bottom:auto;flex-direction:column;gap:6px;padding:8px 6px;max-height:58vh;overflow:auto;background:linear-gradient(180deg,#0b0b0fb3,#0b0b0f99);border:1px solid var(--panel-bd);border-radius:14px;width:46px;transition:width .18s,box-shadow .18s;box-shadow:0 8px 24px rgba(0,0,0,.35);z-index:12}
  #camControls:hover,#camControls.expanded{width:150px}
  #camControls button{justify-content:flex-start;padding:8px 10px;width:100%;font-size:10px;background:#1a1f2a;color:#fff;border:1px solid #ffffff1f;box-shadow:inset 0 0 0 1px #0003}
  #camControls:not(.expanded):not(:hover) button span{display:none}
}
</style>
</head>
<body>
<div id="playerContainer" aria-label="مشغّل متعدد الكاميرات">
  <canvas id="freezeLayer"></canvas>
  <div id="activeCam" class="videoFrame" aria-label="الكاميرا النشطة"></div>
  <div id="mainPreview" class="videoFrame" title="انقر للتكبير/التصغير" aria-label="المعاينة الرئيسية المصغّرة"></div>
  <div class="hint">انقر على المعاينة للتكبير • أو اضغط F</div>

  <!-- بوابة البدء -->
  <div id="gatePlay" role="dialog" aria-modal="true" aria-label="بدء التشغيل">
    <div class="gate-card">
      <div class="icon">▶</div>
      <div>
        <div style="color:#fff;font-weight:800;margin-bottom:6px">ابدأ التشغيل والمزامنة</div>
        <div style="font-size:12px;color:#eaeaf0b3">الشريط يعمل بعد الضغط على تشغيل</div>
      </div>
      <button id="startBtn" aria-label="ابدأ التشغيل الآن">تشغيل/بدء المزامنة</button>
    </div>
  </div>

  <!-- أدوات -->
  <div id="utilityControls" class="vertical">
    <div class="group">
      <button id="btnSplit" title="تقسيم">تقسيم</button>
      <button id="btnFill"  title="ملء المحتوى">ملء</button>
    </div>
    <span class="divider"></span>
    <div class="group">
      <button id="btnSound" data-muted="true" title="صوت">
        <span class="on">🔊</span><span class="off">🔇</span>
      </button>
    </div>
  </div>

  <!-- الشريط الموحّد (مخفي حتى نضغط تشغيل) -->
  <div id="globalControls" class="hidden" role="group" aria-label="تحكم موحّد">
    <button id="gBack" title="⏪ -5s">⏪ 5s</button>
    <button id="gPlay" title="⏯">⏯</button>
    <button id="gFwd"  title="+5s ⏩">5s ⏩</button>
    <input id="scrub" type="range" min="0" max="0" value="0" step="0.01" aria-label="شريط التقدم">
    <div id="timeLabel">00:00 / 00:00</div>
    <div id="delayGroup" title="تأخير موحّد بعد المزامنة (ثواني)">
      <button id="delayMinus">-</button>
      <input id="delayRange" type="range" min="0" max="20" step="0.5" value="5">
      <button id="delayPlus">+</button>
      <div id="delayLabel" style="color:#fff;font:12px system-ui;">Delay: 5.0s</div>
    </div>
  </div>

  <!-- الكاميرات -->
  <div id="camControls" role="toolbar" aria-label="اختيار الكاميرات">
    <button data-cam="cam1"><span>Cam1</span></button>
    <button data-cam="cam2"><span>Cam2</span></button>
    <button data-cam="cam3"><span>Cam3</span></button>
    <button data-cam="cam4"><span>Cam4</span></button>
    <button data-cam="cam5"><span>Cam5</span></button>
    <button data-cam="cam6"><span>Drone</span></button>
    <button data-cam="cam7"><span>Sineflex</span></button>
  </div>
</div>

<script>
/* ===== مصادر ===== */
window.sources = {
  main:  "https://stream.mux.com/jIy7RfNkNJqkZ1008eyc01WH9i4Nh37Q001xqZEdA50000LI.m3u8",
  cam1:  "",
  cam2:  "https://stream.mux.com/pp5DAu5IEgXKGPYByNtH23eb3q7wQrCKjWZYQ02h02Rnc.m3u8",
  cam3:  "",
  cam4:  "https://stream.mux.com/lQPRUXI5ej9dYmgBSy8YYZ6q7H9Rz2hquw8hWULlefA.m3u8",
  cam5:  "",
  cam6:  "https://stream.mux.com/KjaW9wNOl8XKUE3c3xB2aa502gqRnUHmaA3faW7U6nc00.m3u8",
  cam7:  "https://stream.mux.com/01ouHRNKSr8StdRxutJ9vay3yoMin00ia004k01KFXqdFJc.m3u8",
};
</script>

<script>
/* ===== إعداد عام ===== */
const hasUrl = (u)=> typeof u==='string' && /^https?:\/\/.+/.test(u);
const MIRRORS_ENABLED = false;
let performanceLightMode = true;
function levelCapFor(){ return 360; }

const downlinkMbps = (navigator.connection && navigator.connection.downlink) ? navigator.connection.downlink : 2.5;
const HLS_CONFIG_BASE = {
  lowLatencyMode:false, liveSyncDurationCount:3, capLevelToPlayerSize:true,
  maxFragLookUpTolerance:0.25, maxBufferHole:1.0, maxSeekHole:2.0,
  nudgeOffset:0.20, nudgeMaxRetry:6, enableWorker:true, progressive:false,
  abrEwmaDefaultEstimate:Math.max(500_000,Math.min(2_500_000,downlinkMbps*500_000)),
  abrMaxWithRealBitrate:true,
  fragLoadingMaxRetry:6, manifestLoadingMaxRetry:6, levelLoadingMaxRetry:5,
  fragLoadingRetryDelay:350, manifestLoadingRetryDelay:500, levelLoadingRetryDelay:500,
  fragLoadingTimeOut:10000, manifestLoadingTimeOut:8000, levelLoadingTimeOut:8000,
  fpsDroppedMonitoringPeriod:1000, fpsDroppedMonitoringThreshold:0.15,
  xhrSetup:(xhr)=>{ try{xhr.withCredentials=false;}catch(e){} }
};
const HLS_CONFIG = { ...HLS_CONFIG_BASE, maxBufferLength:28, backBufferLength:60 };

async function isCodecSupported(codec){
  if(navigator.mediaCapabilities?.decodingInfo){
    try{
      const info=await navigator.mediaCapabilities.decodingInfo({type:'file',video:{contentType:`video/mp4; codecs="${codec}"`,width:1920,height:1080,bitrate:3_000_000,framerate:30}});
      return !!info.supported;
    }catch(e){}
  }
  const v=document.createElement('video'); return !!v.canPlayType(`video/mp4; codecs="${codec}"`);
}
const SUPPORTS={avc:null,hevc:null};
(async()=>{SUPPORTS.avc=await isCodecSupported('avc1.640028')||await isCodecSupported('avc1.4d401f')||await isCodecSupported('avc1.42E01E'); SUPPORTS.hevc=await isCodecSupported('hvc1.1.6.L93.B0')||await isCodecSupported('hev1.1.6.L93.B0');})();

function pickPlayableLevel(levels){
  let i=levels.findIndex(l=>/avc1/i.test(l?.codecs||l?.codecsVideo||'')); if(i>=0 && SUPPORTS.avc) return i;
  i=levels.findIndex(l=>/(hvc1|hev1)/i.test(l?.codecs||l?.codecsVideo||'')); if(i>=0 && SUPPORTS.hevc) return i;
  return levels?.length?0:-1;
}

/* ===== فجوات ===== */
function hasBufferedAround(video, pad = 0.08){
  try{ const t=video.currentTime||0, r=video.buffered; if(!r||!r.length) return false;
    for(let i=0;i<r.length;i++){ const s=r.start(i), e=r.end(i); if(t>=s-pad && t<=e+pad) return true; } }catch(e){}
  return false;
}
function findNextBufferedStart(video){
  try{ const t=video.currentTime||0, r=video.buffered; if(!r||!r.length) return null;
    for(let i=0;i<r.length;i++){ const s=r.start(i), e=r.end(i); if(t<s) return s+0.04; if(t>=s&&t<=e) return null; } }catch(e){}
  return null;
}
async function healGapIfNeeded(video){
  if(hasBufferedAround(video)) return false;
  const next=findNextBufferedStart(video); if(next==null) return false;
  try{ if('setCurrentTime' in video) await video.setCurrentTime(next).catch(()=>{}); else video.currentTime=next; await video.play().catch(()=>{}); return true; }catch(e){}
  return false;
}
async function waitForSeekable(video, timeoutMs=6000){
  const t0=performance.now();
  return new Promise((resolve)=>{ (function loop(){
    try{ const r=video?.seekable; if(r&&r.length) return resolve(true); }catch(e){}
    if(performance.now()-t0>timeoutMs) return resolve(false);
    setTimeout(loop,120);
  })(); });
}

/* ===== مزامنة وجودة ===== */
const SYNC={ main:{pdtOffset:null}, active:{pdtOffset:null} };
function pdtAlignedTarget(mainCt){ const offM=SYNC.main.pdtOffset, offA=SYNC.active.pdtOffset; if(offM!=null && offA!=null) return (offM + (mainCt||0)) - offA; return mainCt; }

/* ——— حساب التأخير الفعلي ضمن نافذة البث ——— */
function getSeekableMetrics(video){
  try{
    const r=video.seekable; if(!r||!r.length) return null;
    const start=r.start(r.length-1), end=r.end(r.length-1);
    const size=Math.max(0,end-start);
    const isSlidingLive = (!isFinite(video.duration)) || (start>0.1);
    return {start,end,size,isSlidingLive};
  }catch(e){ return null; }
}
let globalDelaySec = 5;      // المطلوب من المستخدم
let appliedDelaySec = 5;     // المطبَّق فعليًا داخل النافذة
const SAFETY_MARGIN = 1.2;   // هامش أمان من طرف الحافة
function computeSafeDelay(){
  const m=getSeekableMetrics(mainPlayer);
  if(!m){ appliedDelaySec = globalDelaySec; return; }
  if(m.isSlidingLive){
    const maxDelay = Math.max(0.6, m.size - SAFETY_MARGIN);
    appliedDelaySec = Math.min(globalDelaySec, maxDelay);
    appliedDelaySec = Math.max(0.5, appliedDelaySec);
  }else{
    appliedDelaySec = globalDelaySec; // VOD
  }
}
function updateDelayLabel(){
  document.getElementById('delayLabel').textContent =
    `Delay: ${globalDelaySec.toFixed(1)}s (فعلي ${appliedDelaySec.toFixed(1)}s)`;
}

/* ===== DOM & حالة ===== */
const root=document.getElementById('playerContainer');
const mainContainer=document.getElementById('mainPreview');
const camContainer=document.getElementById('activeCam');
const freezeLayer=document.getElementById('freezeLayer');
const gatePlay=document.getElementById('gatePlay');
const startBtn=document.getElementById('startBtn');
const btnSplit=document.getElementById('btnSplit');
const btnFill=document.getElementById('btnFill');
const btnSound=document.getElementById('btnSound');
const globalControls=document.getElementById('globalControls');
const gPlay=document.getElementById('gPlay');
const gBack=document.getElementById('gBack');
const gFwd=document.getElementById('gFwd');
const scrub=document.getElementById('scrub');
const timeLabel=document.getElementById('timeLabel');
const delayRange=document.getElementById('delayRange');
const delayMinus=document.getElementById('delayMinus');
const delayPlus=document.getElementById('delayPlus');

let mainPlayer, activePlayer, currentCam="cam2";
let splitMode=0, isMainFull=false, fillMode=false, started=false, inited=false;
let ticker=null,isScrubbing=false;

/* ===== أدوات العرض ===== */
function clampToSeekable(video,t){
  const r=video.seekable; if(!r||!r.length) return t;
  const start=r.start(r.length-1), end=r.end(r.length-1);
  return Math.min(Math.max(t, start+0.05), end-0.05);
}
function fmt(t){ t=Math.max(0,Math.floor(t||0)); const m=String(Math.floor(t/60)).padStart(2,'0'); const s=String(t%60).padStart(2,'0'); return `${m}:${s}`; }
function freezeFrom(video){
  try{
    const w=root.clientWidth,h=root.clientHeight; freezeLayer.width=w; freezeLayer.height=h;
    const ctx=freezeLayer.getContext('2d'); ctx.fillStyle='#000'; ctx.fillRect(0,0,w,h);
    const rect=(video.getBoundingClientRect && video.parentElement)?video.parentElement.getBoundingClientRect():{width:w,height:h,left:0,top:0};
    const scaleX=w/rect.width, scaleY=h/rect.height; ctx.save(); ctx.scale(scaleX,scaleY); ctx.drawImage(video,0,0,rect.width,rect.height); ctx.restore(); freezeLayer.style.opacity='1';
  }catch(e){}
}
function unfreeze(){ freezeLayer.style.opacity='0'; }

/* ===== إنشاء الفيديو ===== */
function createVideo(container, url, role){
  const wrapper=document.createElement('div'); wrapper.style.position='absolute'; wrapper.style.inset='0';
  container.appendChild(wrapper);
  const video=document.createElement('video');
  video.autoplay=false; video.playsInline=true; video.controls=false; video.muted=true; video.preload='auto'; video.crossOrigin='anonymous';
  video.style.width='100%'; video.style.height='100%'; video.style.objectFit=((splitMode===2||fillMode)?'cover':'contain');
  wrapper.appendChild(video);

  if (!hasUrl(url)) return video;

  if(/\.m3u8(\?|$)/i.test(url)){
    if(video.canPlayType('application/vnd.apple.mpegURL')){
      video.src=url;
    }else if(window.Hls && Hls.isSupported()){
      const cfg={...HLS_CONFIG}; const hls=new Hls(cfg); video.__hls=hls; hls.attachMedia(video);
      hls.on(Hls.Events.MANIFEST_PARSED,(_,data)=>{ const idx=pickPlayableLevel(data?.levels||[]); if(idx>=0){ hls.startLevel=idx; hls.currentLevel=idx; hls.nextLevel=idx; }
        const lvls=data.levels||[]; let capIndex=lvls.findIndex(l=>(l.height||0)>=levelCapFor()); if(capIndex<0) capIndex=lvls.length-1; hls.autoLevelCapping=Math.max(0,capIndex-1); });
      hls.loadSource(url);
      hls.on(Hls.Events.LEVEL_UPDATED,(_,data)=>{ if(data?.details?.live){ hls.latencyController?.computeLivePosition?.(); } healGapIfNeeded(video); });
      hls.on(Hls.Events.FRAG_CHANGED,(_,data)=>{ const pdtMs=data?.frag?.programDateTime; if(pdtMs){ const off=pdtMs/1000 - (video.currentTime||0); if(isFinite(off)) SYNC[role].pdtOffset = off; } });
      hls.on(Hls.Events.ERROR,(_,err)=>{
        const d=err||{}; const isNet=d.type===Hls.ErrorTypes.NETWORK_ERROR; const details=String(d.details||'');
        if(isNet){ try{ hls.stopLoad(); }catch(e){} try{ hls.startLoad(0); }catch(e){} healGapIfNeeded(video); return; }
        if(/(BUFFER_|FRAG_PARSING|DECODE|MANIFEST_INCOMPATIBLE_CODECS)/i.test(details)){
          try{ hls.immediateLevelSwitch && hls.immediateLevelSwitch(); }catch(e){} try{ hls.swapAudioCodec?.(); hls.recoverMediaError?.(); }catch(e){} healGapIfNeeded(video); return;
        }
        if(d.fatal){ try{ hls.recoverMediaError?.(); }catch(e){} }
      });
    }else{
      video.src=url;
    }
  }else if(/\.mpd(\?|$)/i.test(url) && window.dashjs){
    const p=dashjs.MediaPlayer().create(); p.initialize(video,url,false);
  }else{
    video.src=url;
  }

  video.addEventListener('loadedmetadata', ()=>{/* لا تشغيل إلا بعد زر البدء */},{once:true});
  video.addEventListener('canplay', ()=>{ [...container.children].slice(0,-1).forEach(ch=>{ try{ const v=ch.querySelector?.('video'); v?.pause?.(); v?.__hls?.destroy?.(); ch.remove(); }catch(e){} }); unfreeze(); }, {once:true});
  return video;
}

/* ===== تشغيل ومزامنة ===== */
function positionUtilityDock(){
  const utilityControls=document.getElementById('utilityControls');
  if(root.classList.contains('main-full')){ utilityControls.style.display='none'; globalControls.style.display='none'; return; }
  utilityControls.style.display='flex';
  globalControls.style.display = started ? 'flex' : 'none';
  const m=10, r=mainContainer.getBoundingClientRect();
  if(splitMode===0){
    utilityControls.classList.add('vertical'); utilityControls.classList.remove('horizontal');
    requestAnimationFrame(()=>{
      const cr=utilityControls.getBoundingClientRect();
      let left=r.left-cr.width-m; if(left<m) left=m;
      let top=r.top+(r.height-cr.height)/2; top=Math.max(m, Math.min(top, window.innerHeight-cr.height-m));
      utilityControls.style.left=left+'px'; utilityControls.style.right='auto'; utilityControls.style.top=top+'px';
    });
  }else{
    utilityControls.classList.remove('vertical'); utilityControls.classList.add('horizontal');
    utilityControls.style.top='10px'; utilityControls.style.right='10px'; utilityControls.style.left='auto';
  }
}
window.addEventListener('resize', positionUtilityDock);
window.addEventListener('orientationchange', ()=>setTimeout(positionUtilityDock,120));
function applySplitClasses(){
  root.classList.toggle('split',splitMode!==0);
  root.classList.toggle('fill',(splitMode!==0&&(splitMode===2||fillMode)));
  [mainContainer,camContainer].forEach(ct=>{ const v=ct.querySelector('video'); if(v){ v.style.objectFit=((splitMode===2||fillMode)?'cover':'contain'); } });
  positionUtilityDock();
}

function initPlayers(){
  if(!mainPlayer){ mainPlayer=createVideo(mainContainer, sources.main, 'main'); }
  activePlayer=createVideo(camContainer, sources[currentCam], 'active');
}
function initPlayersOnce(){
  if(inited) return; inited=true;
  initPlayers();
  document.querySelectorAll('#camControls [data-cam]').forEach(btn=>{
    const id=btn.getAttribute('data-cam');
    if(id!=='cam1' && !hasUrl(sources[id])) btn.style.display='none';
  });
  updateDelayLabel();
  positionUtilityDock();
}

async function playEntity(ent, muted=true){ try{ ent.muted=!!muted; await ent.play(); }catch(e){} }

async function applyGlobalDelay(){
  const mv = mainContainer.querySelector('video');
  if(!mv) return;
  computeSafeDelay();
  const m=getSeekableMetrics(mv); if(!m) return;
  const target = clampToSeekable(mv, m.end - appliedDelaySec);
  await seekMainTo(target);
  await seekActiveTo(pdtAlignedTarget(target));
  updateDelayLabel();
}

function maintainDelayLoop(){
  const mv = mainContainer.querySelector('video');
  if(!mv || mv.paused) return;           // لا نعدّل أثناء الإيقاف
  const m=getSeekableMetrics(mv); if(!m) return;
  computeSafeDelay();
  const current=mv.currentTime||0;
  const diff=(m.end-current)-appliedDelaySec;
  if (Math.abs(diff) > 0.6 && !isScrubbing) {
    seekMainTo(current + diff).then(async ()=>{ const t=await getMainTime(); await seekActiveTo(pdtAlignedTarget(t)); });
  }
}

function getMainTime(){ if(mainPlayer?.getCurrentTime) return mainPlayer.getCurrentTime(); return Promise.resolve(mainPlayer?.currentTime||0); }
function getMainDuration(){
  if(mainPlayer?.getDuration) return mainPlayer.getDuration();
  if(mainPlayer instanceof HTMLVideoElement){
    const d=mainPlayer.duration; if(isFinite(d)) return Promise.resolve(d||0);
    const r=mainPlayer.seekable; if(r&&r.length) return Promise.resolve(r.end(r.length-1)||0);
  }
  return Promise.resolve(0);
}
function seekMainTo(t){ if(mainPlayer?.setCurrentTime) return mainPlayer.setCurrentTime(t).catch(()=>{}); if(mainPlayer?.seekTo){ try{mainPlayer.seekTo(t,true);}catch(e){} return Promise.resolve(); } if(mainPlayer instanceof HTMLVideoElement){ mainPlayer.currentTime=clampToSeekable(mainPlayer,t);} return Promise.resolve(); }
function seekActiveTo(t){ if(activePlayer?.setCurrentTime) return activePlayer.setCurrentTime(t).catch(()=>{}); if(activePlayer?.seekTo){ try{activePlayer.seekTo(t,true);}catch(e){} return Promise.resolve(); } if(activePlayer instanceof HTMLVideoElement){ activePlayer.currentTime=clampToSeekable(activePlayer,t);} return Promise.resolve(); }
async function syncCams(){ const t=await getMainTime(); await seekActiveTo(pdtAlignedTarget(t)); }

function startTimeTicker(){
  if(ticker) return;
  ticker=setInterval(async()=>{
    if(isScrubbing) return;
    const ct=await getMainTime(); let d=await getMainDuration();
    if(mainPlayer instanceof HTMLVideoElement){ const r=mainPlayer.seekable; if(r&&r.length){ d=r.end(r.length-1)||d; } }
    if(d&&isFinite(d)) scrub.max=d;
    scrub.value=ct||0; timeLabel.textContent=`${fmt(ct)} / ${fmt(d||0)}`;
    maintainDelayLoop();
    const target=pdtAlignedTarget(ct); const delta=(activePlayer?.currentTime||0) - target;
    if(!isNaN(delta)) {
      const ad=Math.abs(delta);
      if(ad < 0.06){ activePlayer.playbackRate=1; }
      else if(ad < 0.25){ activePlayer.playbackRate = (delta>0?0.985:1.015); }
      else if(ad < 0.60){ activePlayer.playbackRate = (delta>0?0.95:1.05); }
      else { activePlayer.playbackRate = 1; }
    }
  }, 250);
}

async function startPlayback(){
  if(started) return;
  started=true;
  gatePlay.classList.add('hidden');
  globalControls.classList.remove('hidden');

  await playEntity(mainPlayer,true);
  await playEntity(activePlayer,true);

  await waitForSeekable(mainContainer.querySelector('video'));
  await applyGlobalDelay();
  const mt=await getMainTime(); await seekActiveTo(pdtAlignedTarget(mt));

  startTimeTicker();
  positionUtilityDock();
}

/* ===== تحكمات ===== */
function toggleSound(){
  if(!started) return;
  if(mainPlayer instanceof HTMLVideoElement){
    if(mainPlayer.muted){ mainPlayer.muted=false; mainPlayer.volume=1; mainPlayer.play().catch(()=>{}); }
    else { mainPlayer.muted=true; }
    btnSound.dataset.muted=String(!!mainPlayer.muted);
  }
}
function switchCam(cam, btn){
  if (!hasUrl(window.sources[cam])) return;
  currentCam=cam; if(btn){ btn.classList.add('btn-loading'); setTimeout(()=>btn.classList.remove('btn-loading'),1200); }
  const currentVid = camContainer.querySelector('video') || mainContainer.querySelector('video');
  if(currentVid) freezeFrom(currentVid);

  let newcomer=createVideo(camContainer, sources[cam], 'active');
  let promoted=false;
  const promote=async()=>{ if(promoted) return; promoted=true; activePlayer=newcomer; if(started){ await playEntity(activePlayer,true); const mt=await getMainTime(); await seekActiveTo(pdtAlignedTarget(mt)); } unfreeze(); };
  if(newcomer instanceof HTMLVideoElement){
    newcomer.addEventListener('canplay',promote,{once:true});
    if(started) newcomer.play().catch(()=>{});
    setTimeout(()=>{ if(!promoted){ try{ newcomer.__hls?.recoverMediaError?.(); newcomer.load?.(); if(started) newcomer.play?.(); }catch(e){} setTimeout(()=>{ if(!promoted) promote(); }, 800); } }, 3000);
  } else { promote(); }
}

document.getElementById('camControls').addEventListener('click',(e)=>{ const b=e.target.closest('button[data-cam]'); if(!b) return; switchCam(b.getAttribute('data-cam'), b); });
btnSplit.addEventListener('click', ()=>{ splitMode=(splitMode+1)%3; if(splitMode!==0 && isMainFull){ isMainFull=false; root.classList.remove('main-full'); } applySplitClasses(); });
btnFill.addEventListener('click',  ()=>{ fillMode=!fillMode;  applySplitClasses(); });
btnSound.addEventListener('click', toggleSound);

gBack.addEventListener('click', async()=>{ if(!started) return; const t=await getMainTime(); await seekMainTo(t-5); await seekActiveTo(pdtAlignedTarget(t-5)); });
gFwd .addEventListener('click', async()=>{ if(!started) return; const t=await getMainTime(); await seekMainTo(t+5); await seekActiveTo(pdtAlignedTarget(t+5)); });
gPlay.addEventListener('click', async()=>{ if(!started) return; if(mainPlayer instanceof HTMLVideoElement){ if(mainPlayer.paused){ await mainPlayer.play().catch(()=>{});} else mainPlayer.pause(); const mt=await getMainTime(); await seekActiveTo(pdtAlignedTarget(mt)); }});
scrub.addEventListener('input', ()=>{ if(!started) return; isScrubbing=true; });
scrub.addEventListener('change', async()=>{ if(!started) return; const nt=parseFloat(scrub.value)||0; await seekMainTo(nt); await seekActiveTo(pdtAlignedTarget(nt)); isScrubbing=false; });

delayRange.addEventListener('input', ()=>{ globalDelaySec=parseFloat(delayRange.value)||0; computeSafeDelay(); updateDelayLabel(); });
delayRange.addEventListener('change', ()=>{ if(started) applyGlobalDelay(); });
delayMinus.addEventListener('click', ()=>{ delayRange.value = Math.max(0, (parseFloat(delayRange.value)||0)-0.5); delayRange.dispatchEvent(new Event('input')); if(started) delayRange.dispatchEvent(new Event('change')); });
delayPlus .addEventListener('click', ()=>{ delayRange.value = Math.min(20,(parseFloat(delayRange.value)||0)+0.5); delayRange.dispatchEvent(new Event('input')); if(started) delayRange.dispatchEvent(new Event('change')); });

startBtn.addEventListener('click', startPlayback);

function initPlayersOnce(){
  if(inited) return; inited=true;
  if(!mainPlayer){ mainPlayer=createVideo(mainContainer, sources.main, 'main'); }
  if(!activePlayer){ activePlayer=createVideo(camContainer, sources["cam2"], 'active'); }
  updateDelayLabel();
  positionUtilityDock();
}

window.onYouTubeIframeAPIReady=()=>{ initPlayersOnce(); };
window.addEventListener('DOMContentLoaded',  ()=>{ initPlayersOnce(); });
(function autoUi(){ let t=null; const wake=()=>{ document.body.classList.add('ui-awake'); clearTimeout(t); t=setTimeout(()=>document.body.classList.remove('ui-awake'), 1800); }; ['mousemove','touchstart','touchmove','keydown','click'].forEach(ev=>window.addEventListener(ev,wake,{passive:true})); wake();})();
</script>
</body>
</html>
